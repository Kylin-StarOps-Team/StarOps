/**
 * Emojiå’Œç‰¹æ®Šå­—ç¬¦è¿‡æ»¤å·¥å…·
 * é€‚ç”¨äºé“¶æ²³éº’éºŸç­‰ä¸å®Œå…¨æ”¯æŒUnicodeè¡¨æƒ…çš„ç³»ç»Ÿ
 */

class EmojiFilter {
    constructor() {
        // å¸¸è§emojiåˆ°æ–‡æœ¬çš„æ˜ å°„
        this.emojiMap = {
            // ç³»ç»ŸçŠ¶æ€ç›¸å…³
            'ğŸ¤–': '[AIç³»ç»Ÿ]',
            'ğŸ”': '[æŸ¥è¯¢]',
            'âœ…': '[æˆåŠŸ]',
            'âš ï¸': '[è­¦å‘Š]',
            'âŒ': '[é”™è¯¯]',
            'â°': '[è¶…æ—¶]',
            'ğŸŒ': '[ç½‘ç»œ]',
            'ğŸ“Š': '[æ•°æ®åˆ†æ]',
            'ğŸš€': '[å¯åŠ¨]',
            'ğŸ¯': '[ç›®æ ‡]',
            'ğŸ‰': '[å®Œæˆ]',
            'ğŸ’¡': '[æç¤º]',
            'ğŸ”§': '[ä¿®å¤]',
            'ğŸ“': '[è®°å½•]',
            'ğŸ“‹': '[æ¸…å•]',
            'ğŸ”„': '[å¤„ç†]',
            
            // æŠ€æœ¯ç›¸å…³
            'ğŸ“š': '[çŸ¥è¯†åº“]',
            'ğŸ§ ': '[AI]',
            'âš¡': '[å¿«é€Ÿ]',
            'ğŸ’»': '[ç³»ç»Ÿ]',
            'ğŸ–¥ï¸': '[æ§åˆ¶å°]',
            'ğŸ“ˆ': '[ç›‘æ§]',
            'ğŸ”': '[å®‰å…¨]',
            'ğŸ ': '[ä¸»é¡µ]',
            'â­': '[é‡è¦]',
            'ğŸ¨': '[ç•Œé¢]',
            'ğŸ§ª': '[æµ‹è¯•]',
            
            // çŠ¶æ€æŒ‡ç¤º
            'â¤': '>',
            'â†’': '->',
            'â†': '<-',
            'â†‘': '^',
            'â†“': 'v',
            'âœ“': '[âˆš]',
            'âœ—': '[Ã—]',
            'â—': 'â€¢',
            'â—‹': 'â—¦',
            'â– ': 'â–ª',
            'â–¡': 'â–«',
            
            // ç‰¹æ®Šç¬¦å·
            'â€¦': '...',
            '\u201C': '"',
            '\u201D': '"',
            '\u2018': "'",
            '\u2019': "'",
            '\u2014': '-',
            '\u2013': '-',
            'â€¢': '*',
            'â˜…': '*',
            'â˜†': '*',
            'â™¦': '*',
            'â™ ': '*',
            'â™£': '*',
            'â™¥': '*'
        };
    }
    
    /**
     * è¿‡æ»¤å­—ç¬¦ä¸²ä¸­çš„emojiå’Œç‰¹æ®ŠUnicodeå­—ç¬¦
     * @param {string} text - éœ€è¦è¿‡æ»¤çš„æ–‡æœ¬
     * @return {string} - è¿‡æ»¤åçš„æ–‡æœ¬
     */
    filterEmojis(text) {
        if (!text || typeof text !== 'string') {
            return text;
        }
        
        let filteredText = text;
        
        // 1. æ›¿æ¢å·²çŸ¥çš„emojiæ˜ å°„
        for (const [emoji, replacement] of Object.entries(this.emojiMap)) {
            filteredText = filteredText.replace(new RegExp(emoji, 'g'), replacement);
        }
        
        // 2. ç§»é™¤æ‰€æœ‰emojiï¼ˆUnicodeèŒƒå›´ï¼‰
        // ç§»é™¤è¡¨æƒ…ç¬¦å·å’Œè±¡å½¢æ–‡å­—
        filteredText = filteredText.replace(/[\u{1F600}-\u{1F64F}]/gu, ''); // è¡¨æƒ…ç¬¦å·
        filteredText = filteredText.replace(/[\u{1F300}-\u{1F5FF}]/gu, ''); // æ‚é¡¹ç¬¦å·å’Œè±¡å½¢æ–‡å­—
        filteredText = filteredText.replace(/[\u{1F680}-\u{1F6FF}]/gu, ''); // äº¤é€šå’Œåœ°å›¾ç¬¦å·
        filteredText = filteredText.replace(/[\u{1F1E0}-\u{1F1FF}]/gu, ''); // å›½æ——
        filteredText = filteredText.replace(/[\u{2600}-\u{26FF}]/gu, '');   // æ‚é¡¹ç¬¦å·
        filteredText = filteredText.replace(/[\u{2700}-\u{27BF}]/gu, '');   // è£…é¥°ç¬¦å·
        filteredText = filteredText.replace(/[\u{1F900}-\u{1F9FF}]/gu, ''); // è¡¥å……ç¬¦å·å’Œè±¡å½¢æ–‡å­—
        filteredText = filteredText.replace(/[\u{1FA00}-\u{1FA6F}]/gu, ''); // æ‰©å±•çš„è±¡å½¢æ–‡å­—A
        filteredText = filteredText.replace(/[\u{1FA70}-\u{1FAFF}]/gu, ''); // æ‰©å±•çš„è±¡å½¢æ–‡å­—B
        
        // 3. ç§»é™¤å…¶ä»–å¯èƒ½æœ‰é—®é¢˜çš„Unicodeå­—ç¬¦
        // ç§»é™¤é›¶å®½å­—ç¬¦
        filteredText = filteredText.replace(/[\u200B-\u200F\uFEFF]/g, '');
        // ç§»é™¤ç»„åˆå­—ç¬¦æ ‡è®°
        filteredText = filteredText.replace(/[\u0300-\u036F]/g, '');
        
        // 4. æ¸…ç†å¤šä½™çš„ç©ºæ ¼
        filteredText = filteredText.replace(/\s+/g, ' ').trim();
        
        return filteredText;
    }
    
    /**
     * æ‰¹é‡è¿‡æ»¤å¯¹è±¡ä¸­çš„æ‰€æœ‰å­—ç¬¦ä¸²å€¼
     * @param {Object|Array} obj - éœ€è¦è¿‡æ»¤çš„å¯¹è±¡æˆ–æ•°ç»„
     * @return {Object|Array} - è¿‡æ»¤åçš„å¯¹è±¡æˆ–æ•°ç»„
     */
    filterObject(obj) {
        if (!obj) return obj;
        
        if (typeof obj === 'string') {
            return this.filterEmojis(obj);
        }
        
        if (Array.isArray(obj)) {
            return obj.map(item => this.filterObject(item));
        }
        
        if (typeof obj === 'object') {
            const filtered = {};
            for (const [key, value] of Object.entries(obj)) {
                const filteredKey = this.filterEmojis(key);
                filtered[filteredKey] = this.filterObject(value);
            }
            return filtered;
        }
        
        return obj;
    }
    
    /**
     * æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«å¯èƒ½æœ‰é—®é¢˜çš„å­—ç¬¦
     * @param {string} text - éœ€è¦æ£€æŸ¥çš„æ–‡æœ¬
     * @return {boolean} - æ˜¯å¦åŒ…å«é—®é¢˜å­—ç¬¦
     */
    hasProblematicChars(text) {
        if (!text || typeof text !== 'string') {
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«emojiæˆ–ç‰¹æ®ŠUnicodeå­—ç¬¦
        const problematicPatterns = [
            /[\u{1F600}-\u{1F64F}]/u, // è¡¨æƒ…ç¬¦å·
            /[\u{1F300}-\u{1F5FF}]/u, // æ‚é¡¹ç¬¦å·å’Œè±¡å½¢æ–‡å­—
            /[\u{1F680}-\u{1F6FF}]/u, // äº¤é€šå’Œåœ°å›¾ç¬¦å·
            /[\u{1F1E0}-\u{1F1FF}]/u, // å›½æ——
            /[\u{2600}-\u{26FF}]/u,   // æ‚é¡¹ç¬¦å·
            /[\u{2700}-\u{27BF}]/u,   // è£…é¥°ç¬¦å·
            /[\u{1F900}-\u{1F9FF}]/u, // è¡¥å……ç¬¦å·å’Œè±¡å½¢æ–‡å­—
        ];
        
        return problematicPatterns.some(pattern => pattern.test(text));
    }
}

// åˆ›å»ºå…¨å±€å®ä¾‹
if (typeof module !== 'undefined' && module.exports) {
    module.exports = EmojiFilter;
} else if (typeof window !== 'undefined') {
    window.EmojiFilter = EmojiFilter;
}
